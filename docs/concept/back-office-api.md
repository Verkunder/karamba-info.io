# API back-office concept.

- [Общие положения](#общие-положения).
- [Термины](#термины).
- [Представление о сервисе karamba.media][1].
- [Методы вызова удаленных процедур](#методы-вызова-удаленных-процедур).
  - [Регистрация пользователей](#регистрация-пользователей).
    - [registerCandidat](#registercandidat).
    - [registerPartner](#registerpartner).
    - [updateStatus](#updatestatus).
    - [login](#login).
  - [Информация о пользователях](#информация-о-пользователях).
    - [getUsersList](#getuserslist).
    - [getUserInfo](#getUserInfo).
    - [updateUserInfo](#updateuserinfo).
  - [Информация о тарифах](#информация-о-тарифах).
    - [addTariff](#addTariff).
    - [getTariff](#getTariff).
    - [updateTariff](#updateTariff).
    - [getTariffsList](#gettariffslist).
  - [Информация о заказах пользователя](#информация-о-заказах-пользователя).
    - [getUserApps](#getuserapps).
    - [removeUserApp](#removeuserapp).
  - [Информация о транзакциях](#информация-о-транзакциях).
    - [getBalance](#getbalance).
    - [addTransaction](#addTransaction).
    - [getTransactions](#getTransactions).
- [Объекты трансфера данных](#объекты-трансфера-данных).
    - [UseDTO](#userdto).
    - [PartnersDTO](#partnersdto).
    - [ErrorEnum](#errorenum).
    - [TariffStatusEnum](#tariffstatusenum).
    - [TariffDTO](#tariffdto).
    - [AppDTO](#appdto).
    - [TransactionDTO](#transactiondto).
    - [LanguageEnum](#languageenum).
    - [ApplicationStatusEnum](#applicationstatusenum).


## Общие положения.

Данный документ включает в себя техническую спецификацию API микро сервиса `back-office`.

Back-office - микросервис, осуществляющих доступ/хранение/обновление информации о партнерах. 
Придерживаясь концепции микросервисов, этот элемент системы должен реализовывать единственную 
точку взаимодействия с данными о пользователях [karamba-media](#представление-о-сервисе-karambamedia), состоянии их счетов, 
транзакций, тарифов. Взаимодействие с другими элементами системы осуществляется по 
протоколу [gRPC](#термины).

Учитывая то, что предполагается только внутренний доступ к данному приложению, реализация авторизации запросов не имеет смысла.

На основе этого документа будут разработаны [gRPC](#термины) спеки для использования в проектах `karamba.info` и `karamba.media`.

## Термины.

Данный раздел расширяет соответствующий [раздел технического задания][2].

- `RPC` - (от англ. Remote Procedure Call, RPC) — класс технологий, позволяющих компьютерным программам вызывать 
функции или процедуры в другом адресном пространстве (как правило, на удалённых компьютерах). Подробно [тут][3].
- `gRPC` - расшифровывается как «gRPC Remote Procedure Calls» — фреймворк для удалённого вызова процедур от Google. Подробно [тут][4].
- `кодогенерация` - часть процесса компиляции, когда специальная часть компилятора, кодогенератор, конвертирует синтаксически корректную программу в последовательность инструкций, 
которые могут выполняться на машине. Подробно [тут][5].
- `karamba project` имеется ввиду совокупность всех микросервисов проекта `karamba`.
- `транзакция` - операция начисления/списания денежных средств со счета или на счет клиента.
- `DTO` - Data Transfer Object (DTO) — один из шаблонов проектирования, используется для передачи данных между подсистемами приложения. 
Data Transfer Object, в отличие от business object или data access object не должен содержать какого-либо поведения. Подробнее [тут][6].
- `односторинний hash`- Hash = хеш функция — (свертка) функция однозначного отображения строки (любой длины) на конечное множество (строку заданной длины).  Подробнее [тут][7].
- `timestamp` - Временна́я метка (также метка времени или timestamp с англ. — «временна́я печать») — это последовательность символов или закодированной информации
 показывающей, когда произошло определённое событие. Обычно показывает дату и время (иногда с точностью до долей секунд). Подробнее [тут][8].
- `enum` - Перечисляемый тип (сокращённо перечисле́ние, англ. enumeration, enumerated type) — в программировании тип данных,
чьё множество значений представляет собой ограниченный список идентификаторов. Подробнее [тут][9].
- `валидация` - проверка входящих данных на соответствие заданным условиям (например любой email должен содержать символ `@` и если аргумент, в котором ожидается email пользователя его не содержит, очевидно он не валиден).

## Методы вызова удаленных процедур.

### Регистрация пользователей.

Методы реализующие механизм регистрации пользователей.

#### registerCandidat.

Метод осуществляет добавление в информационную систему нового пользователя с ролью [Кандидат][10] на основе предоставленных данных.

##### Параметры:

- userData: [UseDTO](#userdto) - данные пользователя.

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [UseDTO](#userdto) - данные пользователя содержащие ID.


#### registerPartner.

 Метод осуществляет добавление необходимых данных пользователя с ролью [Кандидат][10] и повышение роли пользователя до роли [Партнер][12].

##### Параметры:

- userID: [uint64][13] - идентификатор пользователя.
- partnerData: [PartnersDTO](#partnersdto) - данные [партнера][12].

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [UseDTO](#userdto) - данные пользователя содержащие ID.


#### updateStatus.

Реализует запрос на активацию/деактивацию аккаунта, к примеру, после подтверждения email или бан.

##### Параметры:

 - userID: [uint64][13] - идентификатор пользователя.
 - status: [StatusEnum](#statusenum) - новый статус пользователя.
 - description: [string][13] - произвольное описание операции.

##### Возвращаемое значение:

- [ErrorEnum](#errorenum) - результат выполнения операции.

#### login.

Возвращает данные пользователя по логину и паролю.

##### Параметры:

- login: [string][13] - логин пользователя.
- password [string][13] - пароль пользователя ([односторонний hash](#термины)).

##### Возвращаемое значение:

-  [OneOf][11] : [ErrorEnum](#errorenum) / [UseDTO](#userdto) - результат выполнения операции.


### Информация о пользователях.

#### getUsersList.

Возвращает список всех пользователей. Т.к. в развитой системе это может быть очень большим массивом данных
в будущем предполагается разработать "фильтры".

#### Параметры:

- нет

##### Возвращаемое значение:

- [OneOf][11]: [ErrorEnum](#errorenum) / [map][14]<[uint64][13], [UseDTO](#userdto)> - результат выполнения операции.

#### getUserInfo.

Возвращает данные пользователя по его ID.

#### Параметры:

- userID: [uint64][13] - идентификатор пользователя.

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [UseDTO](#userdto) - результат выполнения операции.


#### updateUserInfo.

Обновляет данные пользователя.

##### Параметры:

- userData:[UseDTO](#userdto) - данные пользователя, содержащие обновления.

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [UseDTO](#userdto) - результат выполнения операции.


### Информация о тарифах.

Методы, реализующие инструменты работы с [тарифами][16].

#### addTariff.

Добавляет новый [тариф][16].

##### Параметры:

- tariffDTO: [TariffDTO](#tariffdto) - объект данных нового [тарифа][16].

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [TariffDTO](#tariffdto) - результат выполнения операции.

#### getTariff.

Возвращает данные тарифа по ID.

##### Параметры:

- tariffID: [uint32][13] - идентификатор [тарифа][16].

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [TariffVO](#tariffvo) - результат выполнения операции.


#### updateTariff.

Обновляет данные о тарифе.

##### Параметры:

- tariffVO: [TariffVO](#tariffvo) - обновленный объект данных [тарифа][16].

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [TariffVO](#tariffvo) - результат выполнения операции.

#### getTariffsList.

Возвращает список имеющихся тарифов.

##### Параметры:

- нет

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [map][14]<[uint32][13], [TariffVO](#tariffvo)> - результат выполнения операции.

### Информация о заказах пользователя.

Методы предоставляющие возможность манипуляций с заказами пользователей.

#### getUserApps.

Возвращает список приложений пользователя по его ID.

##### Параметры:

- userID: [uint64][13] - уникальный идентификатор пользователя.

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [map][14]<[string][13], [AppDTO](#appdto)> - результат выполнения операции.

#### removeUserApp.

Удаляет из списка приложений пользователя данное приложение по ID.

##### Параметры:

- userID: [uint64][13] - уникальный идентификатор пользователя. 
- appID:  [string][13] - идентификатор приложения.

### Информация о транзакциях.

Методы предоставляющие информацию о транзакциях пользователя.

#### getBalance.

Возвращает текущий баланс пользователя (разницу между дебетом и кредитом).

##### Параметры:

- userID: [int64][13] - уникальный идентификатор пользователя.

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [map][14]<[string][13], [int64][13]> - результат выполнения операции.

#### addTransaction.

Добавляет новую [транзакцию](#термины) и возвращает обновленный баланс пользователя.

##### Параметры:

- userID: [uint64][13] - уникальный идентификатор пользователя.
- transaction: [TransactionDTO](#transactiondto) - объект данных новой [транзакции](#термины).

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [int64][13]- результат выполнения операции.

#### getTransactions.

Возвращает список всех транзакций пользователя.

##### Параметры:

- userID: [uint64][13] - уникальный идентификатор пользователя.

##### Возвращаемое значение:

- [OneOf][11] : [ErrorEnum](#errorenum) / [map][14]<[uint64][13], [TransactionDTO](#transactiondto) - результат выполнения операции.



## Объекты трансфера данных.

[DTO](#термины) объекты данных.

### UserDTO.

Объект данных содержащий информацию о пользователе.

- ID: [uint64][13] - уникальный идентификатор пользователя в системе.
- login: [string][13] - псевдоним, применяемый в качестве login в фомах регистрации/авторизации.
- password:  [string][13] - пароль пользователя для доступа к сервисам в рамках его роли ([односторонний hash](#термины)).
- emali: [string][13] - email пользователя.
- status: [StatusEnum](#statusenum) - текущий статус пользователя.
- agreementAccepted: [boolean][13] - согласие с условиями пользовательского соглашения.
- registrationDate: [uint64][13] - [timestamp](#термины) даты регистрации.
- partnersData:[PartnersDTO](#partnersdto) опционально только для пользователя со стратусом `Партнер` данные партнера.
- lang: [LanguageEnum](#languageenum) язык пользователя.

### PartnersDTO.

Данные пользователя с ролью [Партнер][12].

- ID: [uint64][13] уникальный идентификатор объекта данных.
- firstName: [string][13] реальное имя пользователя.
- lastName: [string][13] реальная фамилия пользователя.
- citizen: [string][13] страна пользователя, гражданином которой он является.
- address: [string][13] адрес проживания пользователя.
- phone: [string][13] контактный телефон.
- registrationDate: [uint64][13] - [timestamp](#термины) даты регистрации партнера.
- agreementAccepted: [boolean][13] согласие с дополнениями к пользовательскому соглашению, 
как минимум согласие на обработку персональных данных.

### TariffDTO.

Информация о [тарифе][16].

- ID:[uint32][13] - уникальный идентификатор объекта данных.
- priceTotal: [uint64][13] - разовая стоимость использования тарифа. (Default: 0).
- pricePerMinute: [uint64][13] - стоимость использования в минуту.  (Default: 0).
- status: [TariffStatusEnum](#tariffstatusenum) - статус тарифа (мы не можем удалять тарифы из ситемы, это грозит потере целостности данных об использовании сервисов, 
поэтому вместо удаления присваиваем соответствующий статус).
- activationDate - [uint64][13] - [timestamp](#термины) дата активации тарифа.
- description - [string][13] - дополнительные данные о тарифе (промо информация).


### AppDTO.

Приложение пользователя. Объект данных, генерируемый системой при выборе пользователя соответствующего тарифа и оплаты его стоимости.

- ID:[string][13] - уникальный идентификатор объекта данных.
- token:[string][13] - строка, являющаяся ключём к возможности испоьзовать услуги сервиса.
- tariff: [TariffDTO](#tariffdto) - ссылка на объект данных применяемого тарифа.
- status: [ApplicationStatusEnum](#applicationstatusenum) - текущий статус приложения.
- activationDate:  [uint64][13] - [timestamp](#термины) дата активации приложения.

### TransactionDTO.

Информация о [транзакции](#термины).

- ID:[uint64][13] уникальный идентификатор объекта данных.
- issueDate: [uint64][13] [timestamp](#термины) дата проведения транзакции.
- amount: [int64][13] сумма транзакции может быть как положительным, так и отрицательным числом.
- userDTO: [userDTO](#userdto) ссылка на данные пользователя.
- description: [string][13] произвольное описание транзакции.



### StatusEnum.

Перечисление возможных статсуов пользователя.

- `DISABLED` - пользователь неактивен, возможно заблокирован или его данные не подтверждены.
- `CANDIDAT` - пользователь имеет роль [Кандидат][10].
- `PARTNER` - пользователь имеет роль [Партнер][12].
- `ADMIN` - пользователь имеет роль [Администратор][15].

### ErrorEnum.

Перечисление кодов возможных ошибок выполнения запросов.

- `SUCCESS` - никакой ошибки нет. Запрос прошел удачно.
- `INTERNAL_ERROR` - ошибка уровня приложения.
- `NOT_FOUND` - объект запроса не найден.
- `NOT_PERMITTED`- не достаточно прав на выполнение операции или операция запрещена по соображениям безопасности.
- `NOT_SUPPORTED` - метод не реализован или не поддерживается.
- `INVALID_ARGS` - данные переданные в качестве аргумента не прошли [валидацию](#термины).
- `TIMEOUT` - превышено время ожидания ответа.
- `CONFLICT` - предложенные изменения несовместимы с текущем состоянием изменяемого объекта данных.

### TariffStatusEnum.

Перечисление статусов тарифа. Статус тарифа предназначен в первую очередь для определения активности тарифа.
Нельзя удалить тариф из системы, если на него ссылаются какие-либо приложения (экземпляры [AppDTO](#appdto)).

- `ACTIVE` - тариф активен, может быть выбран пользователем и применен к его приложению.
- `DISABLED` - тариф не активен (удален, заблокирован, временно преостановлен), соответственно не может быть 
выбран и использован в приложении пользователя ( экземпляре [AppDTO](#appdto)).

### ApplicationStatusEnum.

Перечисление статусов приложения (экземпляра [AppDTO](#appdto)).

- `ACTIVE` - Приложение активно.
- `DISABLED` - Приложение заблокировано, неактивно.



[1]: karamba-info.md#представление-о-сервисе-karambamedia
[2]: karamba-info.md#термины
[3]: https://ru.wikipedia.org/wiki/Удалённый_вызов_процедур
[4]: https://grpc.io
[5]: https://ru.wikipedia.org/wiki/Кодогенерация
[6]: http://design-pattern.ru/patterns/data-transfer-object.html
[7]: http://r3al.ru/bezopasnost/odnostoronnie_hesh_funkcii.htm
[8]: https://ru.wikipedia.org/wiki/Временная_метка
[9]: https://ru.wikipedia.org/wiki/Перечисляемый_тип
[10]: karamba-info.md#кандидат
[11]: https://developers.google.com/protocol-buffers/docs/proto3#oneof
[12]: karamba-info.md#партнер
[13]: https://developers.google.com/protocol-buffers/docs/proto3#scalar
[14]: https://developers.google.com/protocol-buffers/docs/proto3#maps
[15]: karamba-info.md#администратор
[16]: karamba-info.md#тарифные-планы
